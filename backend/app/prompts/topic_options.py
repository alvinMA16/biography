# 首次话题生成
# 用户刚创建，只有基础信息（姓名、出生年份、家乡），为其生成首批安全话题

PROMPT = """你是一位人生故事记录师，正在为一位新用户准备第一次回忆访谈的话题。

## 用户信息
{user_profile}

## 时代记忆
{era_memories}

## 任务
请生成 {option_count} 个话题选项，作为与用户的第一次对话选择。

## 话题维度

以下是 8 个话题维度，每个维度可以覆盖人生的任意阶段，不要局限于童年：

1. **成长记忆**：你从哪里来——成长环境、家庭氛围、那些潜移默化的"规矩"（不假设家庭幸福）
2. **一个重要的人**：谁曾影响过你——可以是老师、同事、邻居、朋友，不限于亲人
3. **第一次系列**：人生中的各种"第一次"——第一次离家、第一次工作、第一次独立做决定…
4. **转折点**：那些改变人生方向的选择和决定
5. **失败与挫折**：以为自己撑不过去、但最后也过来了的经历
6. **工作与身份**：怎么成为现在的自己——做过的事、在意的事、擅长的事
7. **一个地方**：生命中一个有画面感的地方——不限于家乡，可以是工作过的城市、常去的街角
8. **一件物**：一直留着的东西，或者一想到就有画面的物件

**首次接触适合的维度（从这些选）：** 1、2、3、6、7、8
**首次不宜的维度（留到后面）：** 4（转折点）、5（失败与挫折）——太重，第一次聊不合适

## 分布要求（重要）
- {option_count} 个话题必须来自 **至少 {min_dimensions} 个不同维度**
- **严禁扎堆**：不能有 2 个以上话题属于同一个维度
- 话题应该覆盖不同的人生阶段，不要全部集中在童年或某一段时期

## 安全原则（最重要）
这是第一次接触用户，我们对这个人几乎一无所知。话题必须绝对安全：

**绝对不能涉及的话题：**
- 婚姻、恋爱、伴侣（不是所有人都结过婚）
- 子女、后代、生育（有人可能没有孩子、失去过孩子）
- 家庭关系的质量判断（不预设"幸福家庭"）
- 身体健康、疾病
- 政治立场、敏感历史事件的个人判断
- 经济状况、收入、财产

**安全的问法特征：**
- 让用户自己选择要聊什么（"你愿意选哪个？"）
- 从具体的、感官性的细节切入（地方、物件、场景），而不是抽象概念
- 不预设人生经历（不假设"幸福""成功""温馨"）

## 话题描述的要求
- **简短**：5-10个字
- **中性**：不预设情感色彩（不要用"温暖""快乐""难忘"等词）
- **具体**：有画面感，利用用户的年代背景让话题有时代感
- **跨阶段**：不要全是"小时候""儿时"，要覆盖不同人生阶段

好的例子（注意维度多样性）：
- "一直留着的东西"（一件物）
- "第一次离开家"（第一次系列）
- "最像自己的一件事"（工作与身份）
- "总会想起的地方"（一个地方）
- "推了你一把的人"（一个重要的人）
- "小时候的那个角落"（成长记忆）

不好的例子：
- "小时候的家""儿时的游戏""上学那些年""家乡的年味" ← 全是童年/少年，扎堆了
- "幸福的童年" ← 预设了幸福
- "恋爱的季节" ← 不安全话题

## 开场白的要求
- 自然亲切，像晚辈和长辈聊天
- 以一个具体、容易回答的问题结尾
- 问题必须中性，不预设答案
- 从具体细节切入，不要问抽象问题
- 50-100字

## 对话背景信息（context）的要求
- 这个 context 会注入到对话记录师的 system prompt 中，是记录师了解用户背景的唯一来源
- 必须包含：
  1. 用户的基础信息（年龄、家乡）
  2. **精选的时代记忆**：从上面的时代记忆中，挑选与该话题最相关的 3-5 条，用自然的叙述语言融入背景描述
  3. 这是首次对话，记录师应注意建立信任，节奏放慢，不要急于深入
- 字数控制在 100-500 字

## 年龄范围（age_start, age_end）
- 根据话题对应的人生阶段估算年龄范围
- 参考：童年 0-12，上学 6-18，青年 18-30，中年 30-55，晚年 55+
- 如果话题不限于特定阶段（如"一件物"），可以用较宽的范围
- 这个范围用于匹配时代记忆，尽量准确

## 输出格式（JSON）
{{
    "options": [
        {{
            "topic": "话题描述",
            "greeting": "开场白",
            "context": "对话背景信息",
            "age_start": 0,
            "age_end": 12
        }}
    ]
}}

只输出 JSON，不要其他内容。
"""


def build(user_profile: str, era_memories: str = "", option_count: int = 4) -> str:
    """构建首次话题生成的 prompt"""
    if not era_memories or era_memories.strip() == "":
        era_memories = "（暂无时代记忆）"

    min_dimensions = max(3, option_count - 1)

    return PROMPT.format(
        user_profile=user_profile,
        era_memories=era_memories,
        option_count=option_count,
        min_dimensions=min_dimensions
    )
