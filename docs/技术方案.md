# 回忆录产品技术方案

## 一、技术架构总览

```
┌─────────────────────────────────────────────────────────────┐
│                      微信小程序（前端）                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │
│  │  语音录制  │  │  对话界面  │  │ 回忆录查看 │  │  设置页面  │    │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘    │
└─────────────────────────┬───────────────────────────────────┘
                          │ HTTPS
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                      后端服务（Python）                       │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │
│  │  用户服务  │  │  对话服务  │  │ 回忆录服务 │  │  导出服务  │    │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘    │
└───────┬─────────────┬───────────────┬───────────────────────┘
        │             │               │
        ▼             ▼               ▼
┌──────────────┐ ┌──────────┐  ┌──────────────┐
│  PostgreSQL  │ │ 大模型API │  │  腾讯云ASR   │
│   (数据库)    │ │(DeepSeek)│  │   (语音)     │
└──────────────┘ └──────────┘  └──────────────┘
```

---

## 二、技术栈清单

### 2.1 本地体验版

| 层级 | 技术 | 版本 | 用途 |
|-----|------|-----|------|
| 前端 | HTML/CSS/JS | - | Web界面 |
| 后端框架 | FastAPI | 0.100+ | Web API服务 |
| 编程语言 | Python | 3.11+ | 后端开发 |
| 数据库 | SQLite | - | 本地数据存储 |
| ORM | SQLAlchemy | 2.0+ | 数据库操作 |
| 大模型 | DeepSeek API | - | AI对话和内容生成 |

### 2.2 生产版（小程序）

| 层级 | 技术 | 版本 | 用途 |
|-----|------|-----|------|
| 前端 | 微信小程序 | - | 用户界面 |
| 后端框架 | FastAPI | 0.100+ | Web API服务（复用） |
| 编程语言 | Python | 3.11+ | 后端开发 |
| 数据库 | PostgreSQL | 15+ | 数据存储 |
| ORM | SQLAlchemy | 2.0+ | 数据库操作 |
| 大模型 | DeepSeek API | - | AI对话和内容生成 |
| 语音识别 | 微信原生 / 腾讯云ASR | - | 语音转文字 |
| 语音合成 | 微信原生 | - | 文字转语音 |
| 部署 | 腾讯云 | - | 服务器托管 |

---

## 三、数据库设计

### 3.1 用户表 (users)

| 字段 | 类型 | 说明 |
|-----|------|------|
| id | UUID | 主键 |
| openid | VARCHAR(64) | 微信openid |
| nickname | VARCHAR(32) | 昵称（可选） |
| settings | JSONB | 用户设置（文字风格等） |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

### 3.2 对话会话表 (conversations)

| 字段 | 类型 | 说明 |
|-----|------|------|
| id | UUID | 主键 |
| user_id | UUID | 用户ID |
| title | VARCHAR(100) | 会话标题（AI生成） |
| topic | VARCHAR(50) | 话题分类 |
| summary | TEXT | 本次对话摘要 |
| status | VARCHAR(20) | 状态：进行中/已完成 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

### 3.3 对话消息表 (messages)

| 字段 | 类型 | 说明 |
|-----|------|------|
| id | UUID | 主键 |
| conversation_id | UUID | 会话ID |
| role | VARCHAR(10) | user / assistant |
| content | TEXT | 消息内容 |
| audio_url | VARCHAR(255) | 语音文件地址（可选） |
| created_at | TIMESTAMP | 创建时间 |

### 3.4 回忆录表 (memoirs)

| 字段 | 类型 | 说明 |
|-----|------|------|
| id | UUID | 主键 |
| user_id | UUID | 用户ID |
| title | VARCHAR(100) | 章节标题 |
| content | TEXT | 回忆录内容 |
| source_conversations | JSONB | 来源对话ID列表 |
| order_index | INTEGER | 排序序号 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

---

## 四、核心API接口设计

### 4.1 用户相关

```
POST /api/user/login          # 微信登录
GET  /api/user/settings       # 获取用户设置
PUT  /api/user/settings       # 更新用户设置
```

### 4.2 对话相关

```
POST /api/conversation/start  # 开始新对话
POST /api/conversation/chat   # 发送消息（核心接口）
POST /api/conversation/end    # 结束对话
GET  /api/conversation/list   # 获取对话列表
GET  /api/conversation/{id}   # 获取对话详情
```

### 4.3 回忆录相关

```
GET  /api/memoir/list         # 获取回忆录章节列表
GET  /api/memoir/{id}         # 获取章节详情
POST /api/memoir/generate     # 手动触发生成/更新回忆录
POST /api/memoir/export       # 导出回忆录（付费功能）
```

---

## 五、核心流程设计

### 5.1 对话流程

```
用户点击录音 → 微信录音 → 语音转文字 → 发送到后端
    ↓
后端接收文字 → 拼接历史对话 → 调用大模型 → 返回AI回复
    ↓
小程序显示文字 → 调用TTS播放语音
```

### 5.2 大模型 Prompt 设计思路

```
系统角色设定：
- 你是一个温和的晚辈，正在和爷爷/奶奶聊天
- 你对老人的故事充满好奇和兴趣
- 你会适时追问细节，但不会催促
- 你会关注：时间、地点、人物、事件、感受

对话策略：
- 每次回复后提出1-2个追问
- 追问要自然，像聊天一样
- 当一个话题聊得差不多时，可以询问是否想聊别的
```

### 5.3 回忆录生成流程

```
对话结束 → 提取本次对话关键信息 → 生成对话摘要
    ↓
定期任务 → 汇总多次对话 → 调用大模型整理成文 → 保存到回忆录表
```

---

## 六、开发步骤（按顺序执行）

### 第一阶段：环境搭建（1-2天）

| 步骤 | 任务 | 说明 |
|-----|------|------|
| 1.1 | 注册微信小程序 | 去微信公众平台注册小程序账号，获取AppID |
| 1.2 | 申请DeepSeek API | 去DeepSeek官网注册，获取API Key |
| 1.3 | 准备云服务器 | 腾讯云买一台服务器（或先本地开发） |
| 1.4 | 安装PostgreSQL | 在服务器上安装数据库 |
| 1.5 | 搭建项目框架 | 创建后端项目和小程序项目的基础结构 |

### 第二阶段：后端基础开发（3-5天）

| 步骤 | 任务 | 说明 |
|-----|------|------|
| 2.1 | 数据库建表 | 按照上面的设计创建表 |
| 2.2 | 用户登录接口 | 实现微信登录，获取openid |
| 2.3 | 对话接口 | 实现开始对话、发送消息、结束对话 |
| 2.4 | 接入DeepSeek | 调用大模型API，实现AI回复 |
| 2.5 | 回忆录接口 | 实现回忆录的增删改查 |

### 第三阶段：小程序开发（5-7天）

| 步骤 | 任务 | 说明 |
|-----|------|------|
| 3.1 | 首页开发 | 欢迎页、开始对话入口、回忆录入口 |
| 3.2 | 对话页开发 | 语音录制、对话气泡、AI回复显示 |
| 3.3 | 语音功能 | 接入微信录音和语音识别 |
| 3.4 | 回忆录页开发 | 章节列表、内容详情页 |
| 3.5 | 设置页开发 | 文字风格选择、存储方式选择 |

### 第四阶段：AI调优（2-3天）

| 步骤 | 任务 | 说明 |
|-----|------|------|
| 4.1 | 优化Prompt | 调整AI的角色设定和对话风格 |
| 4.2 | 追问策略 | 优化AI的追问逻辑，让对话更自然 |
| 4.3 | 回忆录生成 | 优化从对话生成回忆录的质量 |

### 第五阶段：测试上线（2-3天）

| 步骤 | 任务 | 说明 |
|-----|------|------|
| 5.1 | 功能测试 | 完整跑一遍所有功能 |
| 5.2 | 找老人测试 | 请目标用户试用，收集反馈 |
| 5.3 | 小程序审核 | 提交微信审核 |
| 5.4 | 正式上线 | 审核通过后发布 |

---

## 七、项目目录结构

```
biography/
├── docs/                    # 文档
│   ├── PRD.md
│   └── 技术方案.md
├── backend/                 # 后端代码（体验版和生产版共用）
│   ├── app/
│   │   ├── main.py         # 入口
│   │   ├── config.py       # 配置
│   │   ├── database.py     # 数据库连接
│   │   ├── models/         # 数据模型
│   │   ├── api/            # API接口
│   │   ├── services/       # 业务逻辑
│   │   └── prompts/        # AI Prompt模板
│   ├── requirements.txt
│   └── README.md
├── web/                     # Web前端（体验版）
│   ├── index.html          # 首页
│   ├── chat.html           # 对话页
│   ├── memoir.html         # 回忆录页
│   ├── css/
│   │   └── style.css
│   └── js/
│       ├── api.js          # API调用
│       └── app.js          # 主逻辑
├── miniprogram/            # 小程序代码（生产版，后续开发）
│   ├── pages/
│   ├── components/
│   ├── utils/
│   └── app.json
└── README.md
```

---

## 八、预估开发周期

| 阶段 | 时间 | 累计 |
|-----|------|-----|
| 环境搭建 | 1-2天 | 2天 |
| 后端开发 | 3-5天 | 7天 |
| 小程序开发 | 5-7天 | 14天 |
| AI调优 | 2-3天 | 17天 |
| 测试上线 | 2-3天 | 20天 |

**MVP预计总周期：3-4周**

---

## 九、成本预估（月度）

| 项目 | 预估费用 | 说明 |
|-----|---------|------|
| 云服务器 | ¥100-200 | 2核4G基础配置 |
| 数据库 | ¥0（自建）| 用服务器自建 |
| DeepSeek API | ¥100-500 | 按调用量计费，初期用户少费用低 |
| 腾讯云ASR | ¥0-100 | 有免费额度 |
| **合计** | **¥200-800/月** | 初期成本 |

---

*文档版本：v0.1*
*更新日期：2026-02-24*
